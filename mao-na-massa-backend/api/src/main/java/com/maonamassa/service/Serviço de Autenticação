package com.maonamassa.api.service;

import com.maonamassa.api.dto.LoginRequest;
import com.maonamassa.api.model.Pessoa;
import com.maonamassa.api.repository.PessoaRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import java.util.Optional;

@Service
public class AuthService {

    @Autowired
    private PessoaRepository pessoaRepository;

    @Autowired
    private PasswordEncoder passwordEncoder;

    public Pessoa autenticar(LoginRequest login) {
        // 1. Busca o usuário pelo e-mail
        Optional<Pessoa> pessoaOpt = pessoaRepository.findByEmail(login.getEmail());

        if (pessoaOpt.isEmpty()) {
            throw new RuntimeException("Usuário ou senha inválidos.");
        }

        Pessoa pessoa = pessoaOpt.get();

        // 2. Verifica se a senha bate (senha digitada vs senha hash no banco)
        if (!passwordEncoder.matches(login.getSenha(), pessoa.getSenha())) {
            throw new RuntimeException("Usuário ou senha inválidos.");
        }

        // 3. Retorna o usuário se tudo estiver ok
        return pessoa;
    }
}